<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Image Downloader</title>
  <script src="https://miro.com/app/static/sdk/v2/miro.js"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      padding: 16px;
    }
    button {
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    #status {
      margin-top: 12px;
      font-size: 12px;
      color: #555;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h3>Download selected images</h3>
  <p>1. –í—ã–¥–µ–ª–∏ –Ω–∞ –±–æ—Ä–¥–µ –Ω—É–∂–Ω—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏<br>2. –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ</p>
  <button id="downloadBtn">Download selected images</button>
  <div id="status"></div>

  <script>
    // üîë –°–Æ–î–ê –í–°–¢–ê–í–¨ –°–í–û–ô –†–ï–ê–õ–¨–ù–´–ô –¢–û–ö–ï–ù –í –ö–ê–í–´–ß–ö–ê–•
    const ACCESS_TOKEN = 'eyJtaXJvLm9yaWdpbiI6ImV1MDEifQ_ImGjc66YvP8x8XBTtbUkFWsBeWY';

    document.addEventListener('DOMContentLoaded', () => {
      const statusEl = document.getElementById('status');
      const btn = document.getElementById('downloadBtn');

      function setStatus(text) {
        console.log('[ImageDownloader]', text);
        statusEl.textContent = text;
      }

      async function downloadSelectedImages() {
        // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø—É—Å–∫–∞—Ç—å, –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø—É—Å—Ç–æ–π
        if (!ACCESS_TOKEN) {
          setStatus('ACCESS_TOKEN –ø—É—Å—Ç–æ–π. –í—Å—Ç–∞–≤—å —Ç–æ–∫–µ–Ω –≤ panel.html –≤ const ACCESS_TOKEN.');
          return;
        }

        try {
          setStatus('–ß–∏—Ç–∞—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ä–¥–µ...');
          const boardInfo = await miro.board.getInfo();
          const boardId = boardInfo.id;
          console.log('Board info:', boardInfo);
          setStatus('–ë–æ—Ä–¥: ' + boardId + '\n–ß–∏—Ç–∞—é –≤—ã–¥–µ–ª–µ–Ω–∏–µ...');

          const selection = await miro.board.getSelection();
          console.log('Selection:', selection);

          if (!selection.length) {
            setStatus('–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–¥–µ–ª–µ–Ω–æ –Ω–∞ –±–æ—Ä–¥–µ.');
            return;
          }

          const images = selection.filter(item => item.type === 'image');
          console.log('Images in selection:', images);

          if (!images.length) {
            setStatus('–í–æ –≤—ã–¥–µ–ª–µ–Ω–∏–∏ –Ω–µ—Ç image-—ç–ª–µ–º–µ–Ω—Ç–æ–≤.');
            return;
          }

          setStatus(`–ù–∞–π–¥–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ${images.length}. –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ REST API...`);

          const downloaded = [];
          const errors = [];

          for (let i = 0; i < images.length; i++) {
            const img = images[i];
            const prefix = `(${i + 1}/${images.length}) [${img.id}]`;

            try {
              setStatus(`${prefix} –ü–æ–ª—É—á–∞—é item —á–µ—Ä–µ–∑ /items/{id}...`);

              // 1) –ü–æ–ª—É—á–∞–µ–º item: /v2/boards/{boardId}/items/{itemId}
              const metaResp = await fetch(
                `https://api.miro.com/v2/boards/${boardId}/items/${img.id}`,
                {
                  headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${ACCESS_TOKEN}`,
                  },
                },
              );

              if (!metaResp.ok) {
                const txt = await metaResp.text();
                console.error('Item meta error', metaResp.status, txt);
                errors.push(`${prefix} –û—à–∏–±–∫–∞ meta ${metaResp.status}`);
                continue;
              }

              const metaJson = await metaResp.json();
              console.log('Item meta:', metaJson);

              const imageUrl = metaJson?.data?.imageUrl;
              if (!imageUrl) {
                console.warn('–ù–µ—Ç data.imageUrl –¥–ª—è', img.id, metaJson);
                errors.push(`${prefix} –ù–µ—Ç imageUrl –≤ data`);
                continue;
              }

              // 2) –ü–æ–ª—É—á–∞–µ–º –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π download URL: format=original, redirect=false
              setStatus(`${prefix} –ü–æ–ª—É—á–∞—é download URL...`);

              const urlObj = new URL(imageUrl);
              urlObj.searchParams.set('format', 'original');
              urlObj.searchParams.set('redirect', 'false');

              const resourceResp = await fetch(urlObj.toString(), {
                headers: {
                  'Accept': 'application/json',
                  'Authorization': `Bearer ${ACCESS_TOKEN}`,
                },
              });

              if (!resourceResp.ok) {
                const txt = await resourceResp.text();
                console.error('Resource error', resourceResp.status, txt);
                errors.push(`${prefix} –û—à–∏–±–∫–∞ resource ${resourceResp.status}`);
                continue;
              }

              const resourceJson = await resourceResp.json();
              console.log('Resource json:', resourceJson);

              const downloadUrl = resourceJson.url;
              if (!downloadUrl) {
                console.warn('–ù–µ—Ç –ø–æ–ª—è url –≤ resourceJson', resourceJson);
                errors.push(`${prefix} –í –æ—Ç–≤–µ—Ç–µ resource –Ω–µ—Ç url`);
                continue;
              }

              // 3) –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
              setStatus(`${prefix} –°–∫–∞—á–∏–≤–∞—é —Ñ–∞–π–ª...`);

              const fileResp = await fetch(downloadUrl);
              if (!fileResp.ok) {
                const txt = await fileResp.text();
                console.error('Download error', fileResp.status, txt);
                errors.push(`${prefix} –û—à–∏–±–∫–∞ download ${fileResp.status}`);
                continue;
              }

              const blob = await fileResp.blob();
              const blobUrl = URL.createObjectURL(blob);

              const extFromType = (() => {
                const ct = fileResp.headers.get('Content-Type') || '';
                if (ct.includes('jpeg')) return 'jpg';
                if (ct.includes('png')) return 'png';
                if (ct.includes('gif')) return 'gif';
                if (ct.includes('svg')) return 'svg';
                if (ct.includes('webp')) return 'webp';
                return 'bin';
              })();

              const title = (metaJson.title && metaJson.title.trim()) || '';
              const fileName =
                (title ? title : `miro_image_${i.toString().padStart(3, '0')}`) +
                '.' + extFromType;

              const a = document.createElement('a');
              a.href = blobUrl;
              a.download = fileName;
              document.body.appendChild(a);
              a.click();
              a.remove();
              URL.revokeObjectURL(blobUrl);

              downloaded.push(fileName);
            } catch (e) {
              console.error('Unexpected error for image', img.id, e);
              errors.push(`${prefix} –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞`);
            }
          }

          if (downloaded.length) {
            let msg = `–ì–æ—Ç–æ–≤–æ. –°–∫–∞—á–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${downloaded.length}.`;
            if (errors.length) {
              msg += '\n–ù–æ –±—ã–ª–∏ –æ—à–∏–±–∫–∏:\n' + errors.join('\n');
            }
            setStatus(msg);
          } else {
            let msg = '–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ :(';
            if (errors.length) {
              msg += '\n–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏:\n' + errors.join('\n');
            }
            setStatus(msg);
          }
        } catch (err) {
          console.error('Fatal error:', err);
          setStatus('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ (—Å–º. –∫–æ–Ω—Å–æ–ª—å –ø–∞–Ω–µ–ª–∏): ' + (err.message || err));
        }
      }

      setStatus('–ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ. –í—ã–¥–µ–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–∞ –±–æ—Ä–¥–µ –∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É.');
      console.log('[ImageDownloader] panel loaded');

      btn.addEventListener('click', () => {
        console.log('[ImageDownloader] button clicked');
        downloadSelectedImages();
      });
    });
  </script>
</body>
</html>
